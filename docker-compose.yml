services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${PG_USER:-iot}
      POSTGRES_PASSWORD: ${PG_PASSWORD:-iotpass}
      POSTGRES_DB: ${PG_DB:-iot_portal}
    volumes:
      - postgres_data:/var/lib/postgresql/data

  influxdb:
    image: influxdb:2.7
    restart: unless-stopped
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: ${INFLUX_USERNAME:-admin}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${INFLUX_PASSWORD:-admin123}
      DOCKER_INFLUXDB_INIT_ORG: ${INFLUX_ORG:-iot-org}
      DOCKER_INFLUXDB_INIT_BUCKET: ${INFLUX_BUCKET:-iot_telemetry}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${INFLUX_TOKEN:-dev-token}
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2

  mosquitto:
    image: eclipse-mosquitto:2.0
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./infrastructure/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log

  api:
    build: ./api
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_started
      influxdb:
        condition: service_started
      mosquitto:
        condition: service_started
    ports:
      - "4000:4000"

  frontend:
    build: ./frontend
    env_file:
      - .env
    depends_on:
      api:
        condition: service_started
    ports:
      - "5173:5173"

  ingest:
    build: ./services/ingest
    env_file:
      - .env
    depends_on:
      mosquitto:
        condition: service_started
      influxdb:
        condition: service_started
      api:
        condition: service_started
    restart: unless-stopped

  worker:
    build: ./services/worker
    env_file:
      - .env
    depends_on:
      api:
        condition: service_started
      influxdb:
        condition: service_started
      postgres:
        condition: service_started
    restart: unless-stopped

  simulator:
    build: ./services/simulator
    env_file:
      - .env
    depends_on:
      mosquitto:
        condition: service_started
    profiles:
      - sim
    restart: unless-stopped

volumes:
  postgres_data:
  influxdb_data:
  mosquitto_data:
  mosquitto_log:
